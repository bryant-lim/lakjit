<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakjit | Modern Traditional Chinese Calendar | æ›†æ—¥</title>
    <meta name="description"
        content="Discover Lakjit (æ›†æ—¥), the modern vintage Chinese calendar. Get daily auspicious (Yi/Ji) updates, lunar dates, and traditional quotes in a beautiful, no-scroll layout.">
    <meta name="keywords"
        content="Lakjit, æ›†æ—¥, Chinese Calendar, Lunar Calendar, Hokkien, Auspicious Dates, å®œå¿Œ, Modern Calendar">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Lakjit | Modern Traditional Chinese Calendar">
    <meta property="og:description"
        content="Your daily digital companion for traditional lunar dates and auspicious activities.">
    <meta property="og:url" content="https://lakjit.my/">
    <meta property="og:type" content="website">

    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="{{ url_for('static', filename='lak-jit.jpg') }}">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#F5F5DC">
    <meta name="theme-color" content="#2C2C2C" media="(prefers-color-scheme: dark)">

    <!-- Apple iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lakjit">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-192.jpg') }}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- html2canvas for Share as Image -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body{% if is_night_mode %} class="night-mode" {% endif %}>
    <!-- Cherry Blossom Petals Animation -->
    <div class="sakura-container">
        <div class="petal petal-1"></div>
        <div class="petal petal-2"></div>
        <div class="petal petal-3"></div>
        <div class="petal petal-4"></div>
        <div class="petal petal-5"></div>
        <div class="petal petal-6"></div>
        <div class="petal petal-7"></div>
        <div class="petal petal-8"></div>
        <div class="petal petal-9"></div>
        <div class="petal petal-10"></div>
        <div class="petal petal-11"></div>
        <div class="petal petal-12"></div>
        <div class="petal petal-13"></div>
        <div class="petal petal-14"></div>
        <div class="petal petal-15"></div>
        <div class="petal petal-16"></div>
        <div class="petal petal-17"></div>
        <div class="petal petal-18"></div>
    </div>

    <!-- Theme & Language Toggles -->
    <div class="toggle-controls">
        <!-- Language Toggle -->
        <button class="toggle-button language-toggle" id="language-toggle" aria-label="Switch Language">
            <span class="toggle-text">CN | EN</span>
        </button>

        <!-- Theme Toggle (Day/Night) -->
        <button class="toggle-button theme-toggle" id="theme-toggle" aria-label="Toggle Theme">
            <span class="theme-icon sun-icon">â˜€ï¸</span>
            <span class="theme-icon moon-icon" style="display: none;">ğŸŒ™</span>
        </button>
    </div>

    <div class="container">


        <!-- Content Wrapper for vertical centering -->
        <div class="content-wrapper">
            <!-- Countdown Timer -->
            <div class="countdown-timer">
                <span id="countdown-text">è·é›¢è¾²æ›†æ–°å¹´é‚„æœ‰
                    <span class="countdown-numbers" id="countdown-days">{{ countdown_days }}</span> å¤©
                    <span class="countdown-numbers" id="countdown-hours">{{ countdown_hours }}</span> å°æ™‚
                    <span class="countdown-numbers" id="countdown-minutes">{{ countdown_minutes }}</span> åˆ†
                    <span class="countdown-numbers" id="countdown-seconds">{{ countdown_seconds }}</span> ç§’
                </span>
            </div>

            <!-- Date Header -->
            <div class="date-header">{{ year }} å¹´ {{ month }} æœˆ</div>

            <!-- Big Date -->
            <div class="big-date">{{ day }}</div>

            <!-- Weekday with Lunar Date -->
            <div class="weekday">{{ weekday_zh }} | {{ lunar_date_short }}</div>



            <!-- Divider -->
            <div class="divider"></div>

            <!-- Activities Section (Yi & Ji inline) -->
            <div class="activities">
                <img src="{{ url_for('static', filename='yi-icon.png') }}" alt="å®œ" class="yi-ji-icon"> {% for item in
                good_for %}{{ item }}{% if not loop.last %}ï¼Œ{% endif %}{% endfor %} | <img
                    src="{{ url_for('static', filename='ji-icon.png') }}" alt="å¿Œ" class="yi-ji-icon"> {% for item in
                bad_for %}{{ item }}{% if not loop.last %}ï¼Œ{% endif %}{% endfor %}
            </div>

            <!-- Daily Quote with Lucky Number Feature -->
            <div class="daily-quote-container" id="daily-quote-container">
                <div class="daily-quote">{{ daily_quote }}</div>
            </div>
            <div class="lucky-hint" id="lucky-hint">é»æ“Šé©šå–œ</div>
        </div>

        <!-- Footer -->
        <div class="footer">é¦¬å¹´ğŸ´ 2026</div>

        <!-- Day Progress Bar -->
        <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: {{ day_progress }}%"></div>
        </div>
    </div>

    <!-- PWA Install Button -->
    <button id="install-button" class="install-button">
        <span>ğŸ“±</span>
        <span>å®‰è£æ‡‰ç”¨</span>
    </button>

    <!-- iOS Install Tooltip -->
    <div id="ios-tooltip" class="ios-install-tooltip">
        é»æ“Š Safari çš„ã€Œåˆ†äº«ã€æŒ‰éˆ• <span style="font-size: 16px;">â‹</span>ï¼Œç„¶å¾Œé¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€
    </div>

    <!-- Notification Banner -->
    <div id="notification-banner" class="notification-banner">
        <span class="notification-icon">ğŸ””</span>
        <span class="notification-text">This is a notification banner with slide-down animation!</span>
    </div>

    <!-- Lucky Number Modal -->
    <div id="lucky-modal" class="lucky-number-modal">
        <h3>ğŸ‰ ä»Šæ—¥å¹¸é‹è™Ÿç¢¼ ğŸ‰</h3>
        <div class="lucky-numbers">
            <div class="lucky-number" id="lucky-num-1">0000</div>
            <div class="lucky-number" id="lucky-num-2">0000</div>
        </div>
        <button class="lucky-close-btn" id="lucky-close">é—œé–‰</button>
    </div>

    <!-- Share as Image Button -->
    <button class="share-button" id="share-button" aria-label="Share as image" title="Share as image">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
            <polyline points="16 6 12 2 8 6"></polyline>
            <line x1="12" y1="2" x2="12" y2="15"></line>
        </svg>
    </button>

    <script>
        // Real-time countdown update
        const cnyTimestamp = {{ cny_timestamp }};

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = cnyTimestamp - now;

            if (distance < 0) {
                // After CNY: Show greeting message
                document.getElementById('countdown-text').textContent = 'Lak-Jitæ­ç¥å¤§å®¶ æ­å–œç™¼è²¡ï¼è¬äº‹å¦‚æ„ï¼é¦¬å¹´è¡Œå¤§é‹';
                document.getElementById('countdown-days').textContent = '';
                document.getElementById('countdown-hours').textContent = '';
                document.getElementById('countdown-minutes').textContent = '';
                document.getElementById('countdown-seconds').textContent = '';
                clearInterval(countdownInterval);
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            document.getElementById('countdown-days').textContent = days;
            document.getElementById('countdown-hours').textContent = hours;
            document.getElementById('countdown-minutes').textContent = minutes;
            document.getElementById('countdown-seconds').textContent = seconds;
        }

        // Update every second
        const countdownInterval = setInterval(updateCountdown, 1000);

        // ============================================
        // LANGUAGE & THEME TOGGLE FUNCTIONALITY
        // ============================================

        // English quote from backend (fallback)
        const englishQuoteFallback = '{{ daily_quote_en|safe }}';

        // Lunar date numeric values from backend
        const lunarMonthNum = {{ lunar_month_num }};
        const lunarDayNum = {{ lunar_day_num }};

        // Zen quotes from JSON file
        let zenQuotes = [];
        let selectedZenQuote = '';

        // Fetch Zen quotes from JSON
        async function fetchQuotes() {
            try {
                const response = await fetch('{{ url_for("static", filename="quotes.json") }}');
                const data = await response.json();
                zenQuotes = data.quotes;

                // Deterministic quote selection based on current date
                const today = new Date();
                const dateString = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
                const hashValue = dateString.split('').reduce((acc, char, i) => acc + char.charCodeAt(0) * (i + 1), 0);
                const quoteIndex = hashValue % zenQuotes.length;
                selectedZenQuote = zenQuotes[quoteIndex];
            } catch (error) {
                console.error('Failed to load quotes:', error);
                selectedZenQuote = englishQuoteFallback; // Use fallback if fetch fails
            }
        }

        // Load quotes immediately
        fetchQuotes();

        // Store original Chinese content
        const originalQuote = document.querySelector('.daily-quote').textContent;
        const originalCountdownText = 'è·é›¢è¾²æ›†æ–°å¹´é‚„æœ‰';
        const originalCountdownUnits = { days: 'å¤©', hours: 'å°æ™‚', minutes: 'åˆ†', seconds: 'ç§’' };

        // Initialize from localStorage or defaults
        let currentLang = localStorage.getItem('lakjit-language') || 'cn';
        let currentTheme = localStorage.getItem('lakjit-theme') || 'auto';

        // DOM Elements
        const languageToggle = document.getElementById('language-toggle');
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.querySelector('.sun-icon');
        const moonIcon = document.querySelector('.moon-icon');

        // Store original content for all translatable elements
        const originalDateHeader = document.querySelector('.date-header').textContent;
        const originalWeekday = document.querySelector('.weekday').textContent;

        // Weekday translation mapping
        const weekdayMap = {
            'æ˜ŸæœŸä¸€': 'Monday',
            'æ˜ŸæœŸäºŒ': 'Tuesday',
            'æ˜ŸæœŸä¸‰': 'Wednesday',
            'æ˜ŸæœŸå››': 'Thursday',
            'æ˜ŸæœŸäº”': 'Friday',
            'æ˜ŸæœŸå…­': 'Saturday',
            'æ˜ŸæœŸæ—¥': 'Sunday'
        };

        // Month translation mapping
        const monthMap = {
            '1': 'January',
            '2': 'February',
            '3': 'March',
            '4': 'April',
            '5': 'May',
            '6': 'June',
            '7': 'July',
            '8': 'August',
            '9': 'September',
            '10': 'October',
            '11': 'November',
            '12': 'December'
        };

        // Lunar month translation - using NUMERIC keys to avoid Chinese character ambiguity
        const lunarMonthMap = {
            '1': 'January',
            '2': 'February',
            '3': 'March',
            '4': 'April',
            '5': 'May',
            '6': 'June',
            '7': 'July',
            '8': 'August',
            '9': 'September',
            '10': 'October',
            '11': 'November',
            '12': 'December'
        };

        // Chinese numeral to number conversion for lunar months
        const chineseMonthToNumber = {
            'ä¸€æœˆ': '1', 'äºŒæœˆ': '2', 'ä¸‰æœˆ': '3', 'å››æœˆ': '4',
            'äº”æœˆ': '5', 'å…­æœˆ': '6', 'ä¸ƒæœˆ': '7', 'å…«æœˆ': '8',
            'ä¹æœˆ': '9', 'åæœˆ': '10', 'åä¸€æœˆ': '11', 'åäºŒæœˆ': '12'
        };

        // Language Toggle Function
        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lakjit-language', lang);
            languageToggle.setAttribute('data-lang', lang);

            const dailyQuoteEl = document.querySelector('.daily-quote');
            const countdownTextEl = document.getElementById('countdown-text');
            const dateHeaderEl = document.querySelector('.date-header');
            const weekdayEl = document.querySelector('.weekday');

            if (lang === 'en') {
                // Switch to English - use Zen quote from JSON
                if (selectedZenQuote) {
                    dailyQuoteEl.textContent = selectedZenQuote;
                    dailyQuoteEl.style.fontSize = '2rem'; // Smaller for English
                    dailyQuoteEl.style.letterSpacing = '0.05em'; // Tighter spacing
                    dailyQuoteEl.style.lineHeight = '1.4'; // Allow line breaks
                    dailyQuoteEl.style.maxWidth = '600px'; // Constrain width for line breaks
                }

                // Translate date header (e.g., "2026 å¹´ 1 æœˆ" to "January 2026")
                const yearMatch = originalDateHeader.match(/(\d+)\s*å¹´/);
                const monthMatch = originalDateHeader.match(/(\d+)\s*æœˆ/);
                if (yearMatch && monthMatch) {
                    const year = yearMatch[1];
                    const month = monthMatch[1];
                    dateHeaderEl.textContent = `${monthMap[month]} ${year}`;
                }

                // Translate weekday (e.g., "æ˜ŸæœŸäº” | åäºŒæœˆåä¸€" to "Friday | Lunar December 11")
                const weekdayParts = originalWeekday.split('|');
                if (weekdayParts.length === 2) {
                    const chineseWeekday = weekdayParts[0].trim();

                    const englishWeekday = weekdayMap[chineseWeekday] || chineseWeekday;

                    // Use numeric lunar month and day from backend
                    const englishLunarMonth = lunarMonthMap[lunarMonthNum.toString()] || lunarMonthNum;
                    const englishLunarDate = `Lunar ${englishLunarMonth} ${lunarDayNum}`;

                    weekdayEl.textContent = `${englishWeekday} | ${englishLunarDate}`;
                }

                // Translate Yi/Ji labels to English
                const jiIcon = document.querySelector('.activities img[alt="å®œ"]');
                const yiIcon = document.querySelector('.activities img[alt="å¿Œ"]');
                if (jiIcon) jiIcon.alt = 'Auspicious';
                if (yiIcon) yiIcon.alt = 'Inauspicious';

                // Update countdown text to English (CNY instead of Lunar New Year)
                const daysText = countdownTextEl.querySelector('#countdown-days');
                const hoursText = countdownTextEl.querySelector('#countdown-hours');
                const minutesText = countdownTextEl.querySelector('#countdown-minutes');
                const secondsText = countdownTextEl.querySelector('#countdown-seconds');

                countdownTextEl.innerHTML = `CNY in <span class="countdown-numbers" id="countdown-days">${daysText.textContent}</span> days <span class="countdown-numbers" id="countdown-hours">${hoursText.textContent}</span> hrs <span class="countdown-numbers" id="countdown-minutes">${minutesText.textContent}</span> min <span class="countdown-numbers" id="countdown-seconds">${secondsText.textContent}</span> sec`;

                // Translate lucky hint text
                const luckyHint = document.getElementById('lucky-hint');
                if (luckyHint) luckyHint.textContent = 'Click for surprise';
            } else {
                // Switch to Chinese
                dailyQuoteEl.textContent = originalQuote;
                dailyQuoteEl.style.fontSize = '3.2rem'; // Original size
                dailyQuoteEl.style.letterSpacing = '0.2em'; // Original spacing
                dailyQuoteEl.style.lineHeight = '1.2'; // Reset
                dailyQuoteEl.style.maxWidth = 'none'; // Reset

                // Restore original date header
                dateHeaderEl.textContent = originalDateHeader;

                // Restore original weekday
                weekdayEl.textContent = originalWeekday;

                // Restore Yi/Ji labels to Chinese
                const jiIcon = document.querySelector('.activities img[alt="Auspicious"]');
                const yiIcon = document.querySelector('.activities img[alt="Inauspicious"]');
                if (jiIcon) jiIcon.alt = 'å®œ';
                if (yiIcon) yiIcon.alt = 'å¿Œ';

                // Restore countdown text
                const daysText = countdownTextEl.querySelector('#countdown-days');
                const hoursText = countdownTextEl.querySelector('#countdown-hours');
                const minutesText = countdownTextEl.querySelector('#countdown-minutes');
                const secondsText = countdownTextEl.querySelector('#countdown-seconds');

                countdownTextEl.innerHTML = `è·é›¢è¾²æ›†æ–°å¹´é‚„æœ‰ <span class="countdown-numbers" id="countdown-days">${daysText.textContent}</span> å¤© <span class="countdown-numbers" id="countdown-hours">${hoursText.textContent}</span> å°æ™‚ <span class="countdown-numbers" id="countdown-minutes">${minutesText.textContent}</span> åˆ† <span class="countdown-numbers" id="countdown-seconds">${secondsText.textContent}</span> ç§’`;

                // Restore lucky hint text
                const luckyHint = document.getElementById('lucky-hint');
                if (luckyHint) luckyHint.textContent = 'é»æ“Šé©šå–œ';
            }
        }

        // Helper function to convert Chinese day numerals to Arabic numbers
        function convertChineseDayToNumber(chineseDay) {
            const numeralMap = {
                'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5,
                'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10,
                'åˆ': 0, 'å»¿': 20, 'å…': 30
            };

            let result = 0;
            let temp = 0;

            for (let i = 0; i < chineseDay.length; i++) {
                const char = chineseDay[i];

                if (char === 'åˆ') {
                    continue; // Skip åˆ, next char is the number
                } else if (char === 'å') {
                    if (i === 0 || chineseDay[i - 1] === 'åˆ') {
                        temp = 10;
                    } else if (temp === 0) {
                        temp = 10;
                    } else {
                        temp *= 10;
                    }
                } else if (char === 'å»¿') {
                    temp = 20;
                } else if (char === 'å…') {
                    temp = 30;
                } else if (numeralMap[char]) {
                    if (temp === 10 || temp === 20 || temp === 30) {
                        temp += numeralMap[char];
                    } else {
                        temp = numeralMap[char];
                    }
                }
            }

            result += temp;
            return result || chineseDay; // Return original if conversion fails
        }

        // Theme Toggle Function
        function switchTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('lakjit-theme', theme);

            if (theme === 'night') {
                document.body.classList.add('night-mode');
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else if (theme === 'day') {
                document.body.classList.remove('night-mode');
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            } else {
                // Auto mode - use time-based logic
                checkNightMode();
            }
        }

        // Event Listeners
        languageToggle.addEventListener('click', () => {
            const newLang = currentLang === 'cn' ? 'en' : 'cn';
            switchLanguage(newLang);
        });

        themeToggle.addEventListener('click', () => {
            if (currentTheme === 'auto' || currentTheme === 'day') {
                switchTheme('night');
            } else {
                switchTheme('day');
            }
        });

        // Initialize on page load
        switchLanguage(currentLang);
        switchTheme(currentTheme);

        // Client-side night mode detection
        function checkNightMode() {
            const now = new Date();
            const hour = now.getHours();
            const isNight = hour >= 20 || hour < 7;

            if (isNight) {
                document.body.classList.add('night-mode');
            } else {
                document.body.classList.remove('night-mode');
            }
        }

        // Check night mode on load and every minute
        checkNightMode();
        setInterval(checkNightMode, 60000); // Check every minute

        // Share as Image Functionality
        document.getElementById('share-button').addEventListener('click', async function () {
            const shareContainer = document.createElement('div');
            shareContainer.className = 'share-container';

            const isNightMode = document.body.classList.contains('night-mode');

            if (isNightMode) {
                shareContainer.style.backgroundImage = "url('{{ url_for('static', filename='background-night.jpg') }}')";
                shareContainer.style.color = '#E0E0E0';
                shareContainer.style.filter = 'brightness(0.6)';
            } else {
                shareContainer.style.backgroundImage = "url('{{ url_for('static', filename='background.jpg') }}')";
                shareContainer.style.color = '#000000';
            }

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'share-content';

            const dateHeader = document.querySelector('.date-header');
            if (dateHeader) contentWrapper.appendChild(dateHeader.cloneNode(true));

            const bigDate = document.querySelector('.big-date');
            if (bigDate) contentWrapper.appendChild(bigDate.cloneNode(true));

            const weekday = document.querySelector('.weekday');
            if (weekday) contentWrapper.appendChild(weekday.cloneNode(true));

            const divider = document.createElement('div');
            divider.className = 'divider';
            contentWrapper.appendChild(divider);

            const activities = document.querySelector('.activities');
            if (activities) contentWrapper.appendChild(activities.cloneNode(true));

            const dailyQuote = document.querySelector('.daily-quote');
            if (dailyQuote) contentWrapper.appendChild(dailyQuote.cloneNode(true));

            shareContainer.appendChild(contentWrapper);
            document.body.appendChild(shareContainer);

            try {
                const canvas = await html2canvas(shareContainer, {
                    width: 1080,
                    height: 1350,
                    scale: 2,
                    backgroundColor: null,
                    logging: false,
                    useCORS: true
                });

                canvas.toBlob(function (blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const today = new Date();
                    const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    link.download = `Lakjit-Calendar-${dateStr}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                }, 'image/png');

            } catch (error) {
                console.error('Error generating image:', error);
                alert('Failed to generate image. Please try again.');
            } finally {
                document.body.removeChild(shareContainer);
            }
        });

        // PWA Installation
        let deferredPrompt;
        const installButton = document.getElementById('install-button');
        const iosTooltip = document.getElementById('ios-tooltip');

        if (window.matchMedia('(display-mode: standalone)').matches) {
            installButton.style.display = 'none';
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.add('show');
        });

        installButton.addEventListener('click', async () => {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

            if (isIOS && isSafari) {
                iosTooltip.classList.add('show');
                setTimeout(() => { iosTooltip.classList.remove('show'); }, 5000);
                return;
            }

            if (!deferredPrompt) return;

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            installButton.classList.remove('show');
        });

        window.addEventListener('appinstalled', () => {
            installButton.classList.remove('show');
            deferredPrompt = null;
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((reg) => console.log('SW registered:', reg.scope))
                    .catch((err) => console.log('SW failed:', err));
            });
        }

        // Lucky Number Feature with Slot Machine Animation
        const quoteContainer = document.getElementById('daily-quote-container');
        const luckyModal = document.getElementById('lucky-modal');
        const luckyNum1 = document.getElementById('lucky-num-1');
        const luckyNum2 = document.getElementById('lucky-num-2');
        const luckyCloseBtn = document.getElementById('lucky-close');
        const luckyHint = document.getElementById('lucky-hint');
        let autoCloseTimer;
        let hasInteracted = false;

        function generateLuckyNumber() {
            return Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        }

        function animateSlotMachine(element, finalNumber) {
            element.classList.add('animating');
            let counter = 0;
            const interval = setInterval(() => {
                element.textContent = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                counter++;
                if (counter >= 10) {
                    clearInterval(interval);
                    setTimeout(() => {
                        element.textContent = finalNumber;
                        element.classList.remove('animating');
                    }, 100);
                }
            }, 100);
        }

        function showLuckyNumbers() {
            if (!hasInteracted) {
                luckyHint.classList.add('hidden');
                hasInteracted = true;
            }
            const num1 = generateLuckyNumber();
            const num2 = generateLuckyNumber();
            luckyModal.classList.add('show');
            setTimeout(() => {
                animateSlotMachine(luckyNum1, num1);
                animateSlotMachine(luckyNum2, num2);
            }, 200);
            clearTimeout(autoCloseTimer);
            autoCloseTimer = setTimeout(() => luckyModal.classList.remove('show'), 10000);
        }

        function closeLuckyNumbers() {
            luckyModal.classList.remove('show');
            clearTimeout(autoCloseTimer);
        }

        quoteContainer.addEventListener('click', showLuckyNumbers);
        quoteContainer.addEventListener('touchend', (e) => {
            e.preventDefault();
            showLuckyNumbers();
        });
        luckyCloseBtn.addEventListener('click', closeLuckyNumbers);
        luckyModal.addEventListener('click', (e) => {
            if (e.target === luckyModal) closeLuckyNumbers();
        });

        // ============================================
        // NOTIFICATION BANNER AUTO-DISPLAY LOGIC
        // ============================================

        const testBannerButton = document.getElementById('test-banner-button');
        const notificationBanner = document.getElementById('notification-banner');
        const notificationText = notificationBanner.querySelector('.notification-text');
        let bannerTimeout;

        // Function to show notification banner with a message
        function showNotificationBanner(message) {
            // Clear any existing timeout
            if (bannerTimeout) clearTimeout(bannerTimeout);

            // Update message
            notificationText.textContent = message;

            // Show banner with animation
            notificationBanner.classList.add('show');

            // Auto-hide after 5 seconds
            bannerTimeout = setTimeout(() => {
                notificationBanner.classList.remove('show');
            }, 5000);
        }

        // Check if we should show notification based on lunar date
        function checkLunarNotification() {
            const currentLunarDay = lunarDayNum;

            // Calculate days until next åˆä¸€ (day 1) or åäº” (day 15)
            let daysUntilEvent = 0;
            let eventName = '';

            // Check for åˆä¸€ (day 1)
            if (currentLunarDay === 30 || currentLunarDay === 29) {
                // Tomorrow or day after is åˆä¸€
                daysUntilEvent = currentLunarDay === 30 ? 1 : 2;
                eventName = currentLang === 'cn' ? 'åˆä¸€' : 'Lunar 1st';
            }
            // Check for åäº” (day 15)
            else if (currentLunarDay === 14 || currentLunarDay === 13) {
                daysUntilEvent = 15 - currentLunarDay;
                eventName = currentLang === 'cn' ? 'åäº”' : 'Lunar 15th';
            }

            // Show notification if within 2 days
            if (daysUntilEvent > 0 && daysUntilEvent <= 2) {
                const daysText = currentLang === 'cn' ?
                    (daysUntilEvent === 1 ? 'æ˜å¤©' : 'å¾Œå¤©') :
                    (daysUntilEvent === 1 ? 'tomorrow' : 'in 2 days');

                const message = currentLang === 'cn' ?
                    `æé†’ï¼š${daysText}æ˜¯${eventName}` :
                    `Reminder: ${eventName} ${daysText}`;

                // Show banner after a short delay to ensure page is loaded
                setTimeout(() => showNotificationBanner(message), 1000);
            }
        }

        // Test button click handler
        testBannerButton.addEventListener('click', () => {
            const message = currentLang === 'cn' ?
                'é€™æ˜¯æ¸¬è©¦é€šçŸ¥æ©«å¹…ï¼' :
                'This is a test notification banner!';
            showNotificationBanner(message);
        });

        // Allow manual close by clicking the banner
        notificationBanner.addEventListener('click', () => {
            notificationBanner.classList.remove('show');
            if (bannerTimeout) clearTimeout(bannerTimeout);
        });

        // Check for notifications on page load
        checkLunarNotification();

        // Re-check when language changes (update existing switchLanguage function)
        const originalSwitchLanguage = switchLanguage;
        switchLanguage = function (lang) {
            originalSwitchLanguage(lang);
            // Re-check notification after language change
            setTimeout(() => checkLunarNotification(), 100);
        };
    </script>
    </body>

</html>