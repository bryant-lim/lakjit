<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好日曆 Lak-Jit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="static/style.css">

    <!-- Lunar JavaScript Library -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.7.7/lunar.min.js"></script>
</head>

<body>
    <div class="container">


        <!-- Content Wrapper for vertical centering -->
        <div class="content-wrapper">
            <!-- Countdown Timer -->
            <div class="countdown-timer">
                <span id="countdown-text">距離農曆新年還有
                    <span class="countdown-numbers" id="countdown-days">0</span> 天
                    <span class="countdown-numbers" id="countdown-hours">0</span> 小時
                    <span class="countdown-numbers" id="countdown-minutes">0</span> 分
                    <span class="countdown-numbers" id="countdown-seconds">0</span> 秒
                </span>
            </div>

            <!-- Date Header -->
            <div class="date-header"><span id="year">2026</span> 年 <span id="month">1</span> 月</div>

            <!-- Big Date -->
            <div class="big-date" id="day">01</div>

            <!-- Weekday with Lunar Date -->
            <div class="weekday"><span id="weekday">星期一</span> | <span id="lunar-date">十一月初一</span></div>

            <!-- Divider -->
            <div class="divider"></div>

            <!-- Activities Section (Yi & Ji inline) -->
            <div class="activities" id="activities">
                宜：嫁娶，祭祀，祈福，求嗣 | 忌：掘井，安葬，栽种，出行
            </div>

            <!-- Daily Quote -->
            <div class="daily-quote" id="daily-quote">五福临门</div>
        </div>

        <!-- Footer -->
        <div class="footer">馬年🐴 2026</div>
    </div>

    <!-- Day Progress Bar -->
    <div class="progress-bar-container">
        <div class="progress-bar-fill" id="progress-bar"></div>
    </div>

    <!-- Lunar Notification Banner -->
    <div class="lunar-notification" id="lunar-notification" style="display: none;">
        <img src="static/dark-incense.png" alt="incense" class="incense-icon" id="incense-icon">
        <span class="notification-text" id="notification-text"></span>
        <button class="notification-close" id="notification-close" aria-label="Close notification">×</button>
    </div>

    <script>
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateCalendar();
            updateCountdown();
            updateDayProgress();
            checkNightMode();
            checkLunarNotification();

            // Update countdown every second
            setInterval(updateCountdown, 1000);

            // Update day progress every minute
            setInterval(updateDayProgress, 60000);

            // Check night mode every minute
            setInterval(checkNightMode, 60000);

            // Check lunar notification every hour
            setInterval(checkLunarNotification, 3600000);

            // Setup notification close button
            document.getElementById('notification-close').addEventListener('click', dismissNotification);
        });

        // Update calendar with current date
        function updateCalendar() {
            const now = new Date();
            const solar = Solar.fromDate(now);
            const lunar = Lunar.fromDate(now);

            // Update date elements
            document.getElementById('year').textContent = solar.getYear();
            document.getElementById('month').textContent = solar.getMonth();
            document.getElementById('day').textContent = String(solar.getDay()).padStart(2, '0');

            // Update weekday
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            document.getElementById('weekday').textContent = weekdays[solar.getWeek()];

            // Update lunar date - use numeric month format (十一月 instead of 冬月)
            const monthChineseMap = {
                1: '一', 2: '二', 3: '三', 4: '四', 5: '五', 6: '六',
                7: '七', 8: '八', 9: '九', 10: '十', 11: '十一', 12: '十二'
            };
            const lunarMonthNum = lunar.getMonth();
            const lunarMonthChinese = monthChineseMap[lunarMonthNum] || lunarMonthNum;
            const lunarDay = lunar.getDayInChinese();
            document.getElementById('lunar-date').textContent = lunarMonthChinese + '月' + lunarDay;

            // Update activities (Yi & Ji)
            const yiItems = lunar.getDayYi().slice(0, 4);
            const jiItems = lunar.getDayJi().slice(0, 4);
            document.getElementById('activities').textContent =
                '宜：' + yiItems.join('，') + ' | 忌：' + jiItems.join('，');

            // Update daily quote (random selection)
            const quotes = ['五福临门', '大吉大利', '步步高升', '金玉满堂', '恭喜发财'];
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('daily-quote').textContent = randomQuote;
        }

        // Update countdown to Chinese New Year (Feb 17, 2026)
        function updateCountdown() {
            const now = new Date().getTime();
            const cnyDate = new Date('2026-02-17T00:00:00').getTime();
            const timeRemaining = cnyDate - now;

            if (timeRemaining > 0) {
                const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);

                document.getElementById('countdown-days').textContent = days;
                document.getElementById('countdown-hours').textContent = hours;
                document.getElementById('countdown-minutes').textContent = minutes;
                document.getElementById('countdown-seconds').textContent = seconds;
            } else {
                document.getElementById('countdown-text').textContent = '農曆新年快樂！';
            }
        }

        // Update day progress bar
        function updateDayProgress() {
            const now = new Date();
            const secondsSinceMidnight = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            const totalSecondsInDay = 24 * 3600;
            const progress = (secondsSinceMidnight / totalSecondsInDay) * 100;

            document.getElementById('progress-bar').style.width = progress + '%';
        }

        // Client-side night mode detection
        function checkNightMode() {
            const now = new Date();
            const hour = now.getHours();
            const isNight = hour >= 20 || hour < 7;

            if (isNight) {
                document.body.classList.add('night-mode');
                // Switch to white incense icon in night mode
                document.getElementById('incense-icon').src = 'static/white-incense.png';
            } else {
                document.body.classList.remove('night-mode');
                // Switch to dark incense icon in day mode
                document.getElementById('incense-icon').src = 'static/dark-incense.png';
            }
        }

        // Lunar notification system
        function checkLunarNotification() {
            // 2026 Lunar Calendar: 初一 (Chu 1) and 初十五 (Chu 15) dates
            const lunarDates = [
                { date: '2026-02-17', type: '初一', name: 'CNY' },
                { date: '2026-03-03', type: '初十五' },
                { date: '2026-03-18', type: '初一' },
                { date: '2026-04-01', type: '初十五' },
                { date: '2026-04-17', type: '初一' },
                { date: '2026-05-01', type: '初十五' },
                { date: '2026-05-16', type: '初一' },
                { date: '2026-05-30', type: '初十五' },
                { date: '2026-06-15', type: '初一' },
                { date: '2026-06-29', type: '初十五' },
                { date: '2026-07-14', type: '初一' },
                { date: '2026-07-28', type: '初十五' },
                { date: '2026-08-12', type: '初一' },
                { date: '2026-08-26', type: '初十五' },
                { date: '2026-09-11', type: '初一' },
                { date: '2026-09-25', type: '初十五' },
                { date: '2026-10-10', type: '初一' },
                { date: '2026-10-24', type: '初十五' },
                { date: '2026-11-09', type: '初一' },
                { date: '2026-11-23', type: '初十五' },
                { date: '2026-12-09', type: '初一' },
                { date: '2026-12-23', type: '初十五' },
                { date: '2027-01-19', type: '初一' },
                { date: '2027-02-02', type: '初十五' }
            ];

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (const lunarDate of lunarDates) {
                const targetDate = new Date(lunarDate.date);
                targetDate.setHours(0, 0, 0, 0);

                const daysDiff = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));

                // Check if notification was already dismissed for this event
                const storageKey = `lunar-notification-${lunarDate.date}`;
                const isDismissed = localStorage.getItem(storageKey);

                if (isDismissed) {
                    continue; // Skip if already dismissed
                }

                let message = '';

                // T-minus 2 days
                if (daysDiff === 2) {
                    message = `提醒：2天後是${lunarDate.type}`;
                }
                // T-minus 1 day
                else if (daysDiff === 1) {
                    message = `提醒：明天是${lunarDate.type}`;
                }

                if (message) {
                    showNotification(message, lunarDate.date);
                    return; // Show only one notification at a time
                }
            }

            // Hide notification if no upcoming events
            hideNotification();
        }

        function showNotification(message, eventDate) {
            const notification = document.getElementById('lunar-notification');
            const notificationText = document.getElementById('notification-text');

            notificationText.textContent = message;
            notification.style.display = 'flex';
            notification.dataset.eventDate = eventDate; // Store event date for dismissal
        }

        function hideNotification() {
            const notification = document.getElementById('lunar-notification');
            notification.style.display = 'none';
        }

        function dismissNotification() {
            const notification = document.getElementById('lunar-notification');
            const eventDate = notification.dataset.eventDate;

            if (eventDate) {
                // Store dismissal in local storage
                const storageKey = `lunar-notification-${eventDate}`;
                localStorage.setItem(storageKey, 'true');
            }

            // Hide notification with fade out
            notification.style.opacity = '0';
            setTimeout(() => {
                hideNotification();
                notification.style.opacity = '1'; // Reset for next time
            }, 300);
        }
    </script>
</body>

</html>